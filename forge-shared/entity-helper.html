<script>
(function() {

  "use strict";

  ForgeWebComponents.Helpers = window.ForgeWebComponents.Helpers || {};
  ForgeWebComponents.Helpers.EntityHelper = {
    pluralize: pluralize,
    createLink: createLink,
    createSearchLink: createSearchLink,
    getFriendlyName: getFriendlyName,
    canPluralize: canPluralize,
    getPluralFriendlyName : getPluralFriendlyName
  };

  var customEntityDefinitions = ForgeWebComponents.Config["deltatre.forge.wcm"].CustomEntitiesConfiguration.Definitions;

  var CUSTOM_ENTITY_PREFIX = "customentity.";
  var customEntities = customEntityDefinitions.reduce(function(o, v) {
    o[v.Code.toLowerCase()] = v;
    return o;
  }, {});

  function sanitizeEntityType(entityType) {
    entityType = entityType.toLowerCase();
    if (entityType.startsWith(CUSTOM_ENTITY_PREFIX))
      return entityType.substring(CUSTOM_ENTITY_PREFIX.length);
    return entityType;
  }

  function getFriendlyName(entityType) {

    entityType = sanitizeEntityType(entityType);
    if (customEntities[entityType])
      return customEntities[entityType].Name;
    return entityType.charAt(0).toUpperCase() + entityType.slice(1);

  }

  function getPluralFriendlyName(entityType) {
    return canPluralize(entityType) ? pluralize(entityType) : getFriendlyName(entityType);
  }

  function pluralize(entityType) {

    if (entityType.endsWith("y")) {
      return entityType.substring(0, entityType.length - 1) + "ies";
    }
    if (entityType.endsWith("s") ||
        entityType.endsWith("x") ||
        entityType.endsWith("sh") ||
        entityType.endsWith("ch")) {
      return entityType + "es";
    }
    return entityType + "s";

  }

  function canPluralize(entityType) {

    switch (entityType) {
      case "story":
      case "photo":
      case "document":
      case "tag":
      case "selection":
      case "album":
        return true;
      break;

      default:
        return false;
      break;
    }
  }

  function createLink(entityType, entityId, translationId) {

    var rootUrl = "#/wcm/";
    var result;

    switch (entityType) {
      case "story":
        result = rootUrl + pluralize(entityType) + "/" + translationId
        break;
      case "photo":
      case "document":
      case "tag":
      case "selection":
      case "album":
        result = rootUrl + pluralize(entityType) + "/" + entityId
        break;
      default:
        result = rootUrl + "custom/" + entityType + "/" + entityId;
        break;
    }

    return result;

  }

  function createSearchLink(entityType, query){
    var rootUrl = "#/wcm/";
    var result;

    switch (entityType) {
      case "story":
      case "photo":
      case "document":
      case "tag":
      case "selection":
      case "album":
        result = rootUrl + pluralize(entityType);
        break;
      default:
        result =  rootUrl + "custom/" + entityType;
        break;
    }
    if(result && query){
      var queryString = "?search=";

      for(var k in query){
        queryString += (k.toLowerCase() + ":" + query[k] + " ");
      }

      queryString = queryString.trim();

      result += encodeURI(queryString);
    }

    return result;
  }

})();
</script>
