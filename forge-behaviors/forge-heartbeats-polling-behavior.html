<link rel="import" href="../shared/variables.html">
<link rel="import" href="../forge-api/forge-api.html">

<script>
(function() {

  window.ForgeWebComponents = window.ForgeWebComponents || {};
  ForgeWebComponents.Behaviors = ForgeWebComponents.Behaviors || {};

  var instances = [];
  var _pollingHeartbeats = false;
  var hbApi = ForgeWebComponents.Api.HeartBeats;

  function pollHeartbeats() {

    if (instances.length < 1) return;

    var start = +new Date();

    hbApi.fetchByRoleType().then(function(result) {
      instances.forEach(function(i) {
        i.onHeartbeat(result);
      });
      var end = +new Date();
      var timeout = 5000 - (end - start);
      setTimeout(pollHeartbeats, Math.max(timeout, 0));

    });

  }

  ForgeWebComponents.Behaviors.HeartbeatsPollingBehavior = {

    detached: function() {
      console.log('heartbeats detached');
      this.arrayDelete(instances, this);
    },
    attached: function() {
      console.log('heartbeats attached');
      instances.push(this);
      this.pollHeartbeats();
    },
    pollHeartbeats: function() {
      if (_pollingHeartbeats) return;
      _pollingHeartbeats = true;
      pollHeartbeats();
    },
    onHeartbeat: function() {
      console.error("onHeartbeat not properly overridden");
    }

  };

})();
</script>
