<link rel="import" href="../libraries/libraries.html">
<link rel="import" href="../shared/variables.html">
<link rel="import" href="../shared/api.html">

<script>
(function() {

  window.ForgeWebComponents = window.ForgeWebComponents || {};
  ForgeWebComponents.Behaviors = ForgeWebComponents.Behaviors || {};

  var instances = [];

  var _pollingHeartbeats = false;

  function pollHeartbeats() {

    if (instances.length < 1) return;

    var start = +new Date();

    ForgeWebComponents.Api.HeartBeats().then(function(result) {
      instances.forEach(function(i) {
        i.onHeartbeat(result);
      });
      var end = +new Date();
      var timeout = 5000 - (end - start);
      setTimeout(pollHeartbeats, Math.max(timeout, 0));

    });

  }

  ForgeWebComponents.Behaviors.HeartbeatsPollingBehavior = {

    detached: function() {
      this.arrayDelete(instances, this);
    },
    ready: function() {
      instances.push(this);
      this.pollHeartbeats();
    },
    pollHeartbeats: function() {
      if (_pollingHeartbeats) return;
      _pollingHeartbeats = true;
      pollHeartbeats();
    },
    onHeartbeat: function() {
      console.error("onHeartbeat not properly overridden");
    }

  };

})();
</script>
