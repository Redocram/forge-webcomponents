<dom-module id="key-numbers-input">
    <template>

        <style is="custom-style">
        </style>

        <label>
            [[label]]
            <paper-icon-button on-click="onAdd" icon="add-circle"></paper-icon-button>
        </label>

        <div>
            <iron-list items="[[value]]">
                <template>
                    <div>
                        <h5>{{item.key}}</h5>
                        <span>value {{item.value}}</span>

                        <paper-icon-button on-click="onEdit" icon="editor:mode-edit"></paper-icon-button>
                        <paper-icon-button on-click="onRemove" icon="remove-circle"></paper-icon-button>
                    </div>
                </template>
            </iron-list>
        </div>

        <paper-dialog id="editModal" modal on-iron-overlay-closed="onEditModalClose">
            <h2>Edit key number</h2>
            <paper-input value="{{_editingItem.key}}" label="Key" type="string"></paper-input>
            <paper-input value="{{_editingItem.value}}" label="Value" type="number"></paper-input>

            <div>
                <paper-button dialog-confirm autofocus>Close</paper-button>
            </div>
        </paper-dialog>
    </template>

    <script>
        Polymer({
            is: 'key-numbers-input',
            behaviors: [ForgeWebComponents.Behaviors.ExtendedFieldArrayBehavior],

            listeners: {
            },

            onInput: function () {
                this.debounce('triggerOnValueChanged', this.triggerOnValueChanged, 2000);
            },
            onChange: function () {
                this.debounce('triggerOnValueChanged', this.triggerOnValueChanged, 0);
            },

            onAdd: function () {
                if (!this.value) {
                    this.value = [];
                }

                var entry = {};
                this._isNewEntry = true;
                this.set('_editingItem', entry);

                this.$.editModal.open();
            },

            onEdit: function (e) {
                this._isNewEntry = false;
                this.set('_editingItem', e.model.item);

                this.$.editModal.open();
            },

            onRemove: function (e) {
                var entry = e.model.item;
                var index = this.value.indexOf(entry);
                this.splice('value', index, 1);

                this.onChange();
            },

            onEditModalClose: function (e) {
                var entry = this._editingItem;
                if (entry.value) entry.value = Number(entry.value);
                console.log(isEmpty(entry));

                if (this._isNewEntry && !isEmpty(entry)) {
                    this.push('value', entry);
                    this.onChange();
                }                
            }
        });

        isEmpty = function (obj) {
            for (var prop in obj) {
                if (obj.hasOwnProperty(prop))
                    return false;
            }

            return JSON.stringify(obj) === JSON.stringify({});
        };        
    </script>

</dom-module>