<link rel="import" href="../paper-typeahead-input/paper-typeahead-input.html">

<dom-module id="key-numbers-input">
    <template>

        <style is="custom-style">
        </style>

        <label>
            [[label]]
            <paper-icon-button on-click="onAdd" icon="add-circle"></paper-icon-button>
        </label>

        <div>
            <iron-list items="[[value]]">
                <template>
                    <div>
                        <h5>{{item.key}}</h5>
                        <span>Value: {{item.value}}</span>

                        <paper-icon-button on-click="onEdit" icon="editor:mode-edit"></paper-icon-button>
                        <paper-icon-button on-click="onRemove" icon="remove-circle"></paper-icon-button>
                    </div>
                </template>
            </iron-list>
        </div>

        <paper-dialog id="modal" modal>
            <h2>{{modalTitle}}</h2>
            <paper-typeahead-input input-value="{{_editingItem.key}}" label="Key" type="string" hidden$="[[!_isNewEntry]]" local-candidates="[[_candidates]]"></paper-typeahead-input>
            <paper-input value="{{_editingItem.value}}" label="Value"></paper-input>

            <div>
                <paper-button on-tap="onModalClose">[[modalButtonLabel]]</paper-button>
                <paper-button dialog-dismiss>Close</paper-button>
            </div>
        </paper-dialog>
    </template>

    <script>
        Polymer({
            is: 'key-numbers-input',
            behaviors: [ForgeWebComponents.Behaviors.ExtendedFieldArrayBehavior],

            properties: {
                modalTitle: {
                    type: String
                },
                modalButtonLabel: {
                    type: String
                },
                _candidates: {
                    type: Array
                }
            },

            listeners: {
            },

            onInput: function () {
                this.debounce('triggerOnValueChanged', this.triggerOnValueChanged, 2000);
            },
            onChange: function () {
                this.debounce('triggerOnValueChanged', this.triggerOnValueChanged, 0);
            },

            onAdd: function () {
                this.modalTitle = "Add Key Number";
                this.modalButtonLabel = "Add";
                this._candidates = this._computeAllowedValues(this.schema);

                if (!this.value) {
                    this.value = [];
                };

                var entry = {};
                this._isNewEntry = true;
                this.set('_editingItem', entry);

                this.$.modal.open();
            },

            onEdit: function (e) {
                this.modalTitle = "Edit Key Number";
                this.modalButtonLabel = "Edit";
                this._isNewEntry = false;
                this._oldValue = e.model.item.value;
                this.set('_editingItem', e.model.item);

                this.$.modal.open();
            },

            onRemove: function (e) {
                var entry = e.model.item;
                var index = this.value.indexOf(entry);
                this.splice('value', index, 1);

                this.onChange();
            },

            onModalClose: function (e) {
                var entry = this._editingItem;
                if (!this._inputValidation(entry)) {
                    return;
                };                

                if (this._isNewEntry) {
                    if (!this.isEmpty(entry)) {
                        this.push('value', entry);
                        this.onChange();
                    };
                } else if (this._oldValue != entry.value) {
                    this.onChange();
                };
                this.$.modal.close();
            },

            _inputValidation: function (entry) {
                var areImputsValid;

                if (this._isNewEntry && entry.value && this._candidates.includes(entry.key)) {
                    areImputsValid = true;
                }else if ((!this._isNewEntry && entry.value)){
                    areImputsValid = true;
                }
                return areImputsValid;
            },

            isEmpty: function (obj) {
                for (var prop in obj) {
                    if (obj.hasOwnProperty(prop))
                        return false;
                };

                return JSON.stringify(obj) === JSON.stringify({});
            },

            isEditView: function () {
                return this.modalButtonLabel == 'Edit';
            },

            closeModal: function () {
                this.$.modal.close();
            },

            _computeAllowedValues: function (schema) {

                var allValues = schema.items.properties.key.enum || [];
                var insertedValues = [];

                this.value.forEach(function (item) {
                    insertedValues.push(item.key)
                });

                var result = allValues.filter(function (v) {
                    return insertedValues.indexOf(v) < 0;
                });
                return result;

            }
        });
        //# sourceURL=somename.js        
    </script>

</dom-module>