<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/polymer/polymer.html">

<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-styles/color.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-item/paper-item.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-item/paper-icon-item.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-item/paper-item-body.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-button/paper-button.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-icon-button/paper-icon-button.html">

<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-card/paper-card.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-styles/typography.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-ripple/paper-ripple.html">

<link rel="import" href="../forge-shared/forge-icons.html">
<link rel="import" href="../forge-shared/forge-shared.html">
<link rel="import" href="../forge-api/forge-api.html">

<link rel="import" href="../forge-behaviors/forge-scheduled-stats-behavior.html">
<link rel="import" href="../forge-behaviors/forge-localize-behavior.html">

<link rel="import" href="../moment-element/moment-element.html">

<dom-module id="forge-scheduled-completed-card">

<style>
:host {
  display: block;
}

paper-card {
  display: block;
}

paper-icon-item {
  cursor: pointer;
  cursor: hand;
}

.loading-bar {
  --paper-progress-active-color: var(--paper-light-blue-500);
  width: 100%;
  position: absolute;
}

.header {
  font-weight: 400;
  font-size: 16px;
}

.strong {
  font-weight: 700;
}

.entity-icon-wrapper {
  display: inline-block;
  box-sizing: border-box;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--google-grey-300);
}
.entity-icon {
  margin: 8px;
  width: 24px;
  height: 24px;
  --iron-icon-fill-color: white;
}
</style>

<template>

  <paper-card heading="[[localize('Completed Schedules')]]">

    <paper-progress hidden$="[[hideLoading]]" class="loading-bar" indeterminate></paper-progress>

    <div class="card-content">

      <template is="dom-if" if="[[entities.length]]">

        <template is="dom-repeat" items="{{entities}}">

          <paper-icon-item on-tap="_openItem">
            <paper-ripple></paper-ripple>
            <div class="entity-icon-wrapper" style$="background:[[item.IconItem.color]]" item-icon>
              <iron-icon class="entity-icon" icon="[[item.IconItem.icon]]"></iron-icon>
            </div>
            <paper-item-body two-line>
              <div class="header">[[item.Title]] ([[localize(item.EntityType)]])</div>
              <div secondary>
                <span>[[localize(item.Command)]]</span> <moment-element date-time="[[item.ScheduleInfo.ScheduleAt]]"></moment-element>
              </div>
            </paper-item-body>
          </paper-icon-item>

        </template>

      </template>

      <template is="dom-if" if="[[!entities.length]]">

        [[localize("wcm.noEntitiesScheduledCompleted")]]

      </template>

    </div>


  </paper-card>

</template>

<script>
(function() {
  "use strict";
  var from = new Date();
  from.setDate(from.getDate() - 2);
  var apiUrl = "/deltatre.forge.wcm/api/scheduled/completed?limit=5&from=" + from.toJSON();

  Polymer({
    is: 'forge-scheduled-completed-card',
    behaviors: [ForgeWebComponents.Behaviors.ScheduledStatsPollingBehavior, ForgeWebComponents.Behaviors.ForgeLocalizeBehavior],
    entities: [],
    hideLoading: true,
    ready: function(){
      this.polling.register(apiUrl, this);
    },
    attached: function() {
      this.polling.start();
    },
    detached: function() {
      this.polling.unregister(apiUrl, this);
    },
    onPollingUpdate: function(result) {

      result.forEach(function(e) {
        e.IconItem = ForgeWebComponents.Settings.EntityIcons[e.EntityType];
        //e.Link = ForgeWebComponents.Helpers.EntityHelper.createLink(e.EntityType, null, e.Id, e.TranslationId);
      });

      this.entities = result;
      this.hideLoading = true;
    },
    onPollingStart: function() {
      this.hideLoading = false;
    },
    _openItem: function(e) {
      var entity = e.model.item;
      var href = ForgeWebComponents.Helpers.EntityHelper.createLink(entity.EntityType, null, entity.EntityId, entity.TranslationId);
      if (href) location.href = href;
    }
  });

})();
</script>

</dom-module>
