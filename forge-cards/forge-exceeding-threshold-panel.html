<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/polymer/polymer.html">

<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-item/paper-item-body.html">

<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/iron-icons/iron-icons.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/iron-icons/image-icons.html">

<link rel="import" href="../forge-behaviors/forge-metrics-polling-behavior.html">

<dom-module id="forge-exceeding-threshold-panel">

<style>
:host {
  display: block;
}

.header{
  background-color: var(--status-neutral-dark-color);
  color: white;
  padding: 0 4px;
  font-weight: 600;
  font-size: 18px;
}

.icon {
  width: 72px;
  height: 72px;
  opacity: 0.5;
  float:right;
}

.item {
  color: var(--paper-grey-900);
  background-color: var(--status-neutral-color);
}

.metrics-values{
  position: relative;
  height: 72px;
}

.metrics-text {
  position:absolute;
  bottom: 0;
  padding: 4px;
}

.strong{
  font-weight: 600;
  font-size: 24px;
}

.threshold-warning {
  background-color: var(--status-yellow-color);
}
.threshold-warning .header {
  background-color: var(--status-yellow-dark-color);
}

.threshold-danger {
  background-color: var(--status-red-color);
}
.threshold-danger .header {
  background-color: var(--status-red-dark-color);
}

.threshold-success {
  background-color: var(--status-green-color);
}
.threshold-success .header {
  background-color: var(--status-green-dark-color);
}
</style>

<template>

    <paper-item-body two-line class$="item [[threshold]]">
      <span class="header">[[title]]</span>
      <div class="metrics-values">
        <div class="metrics-text">
          <template is="dom-repeat" items="[[items]]">
            [[item.name]]	<span class="strong">[[item.value]]</span>
          </template>
        </div>
        <iron-icon class="icon" icon="[[icon]]"></iron-icon>
      </div>
    </paper-item-body>

</template>

<script>
(function() {
  "use strict";

  function Entry(name, value) {
    this.name = name;
    this.value = value;
  }

  Polymer({
    is: 'forge-exceeding-threshold-panel',
    behaviors: [ForgeWebComponents.Behaviors.MetricsPollingBehavior],
    properties: {
      url: {
        type: String
      },
      items: {
        type: Array,
        value: [],
        readOnly: true
      },
      icon: {
        type: String
      },
      title:{
        type: String
      },
      threshold: {
        type: String,
        readOnly: true
      },
      thresholdWarning: {
        type: Number
      },
      thresholdDanger: {
        type: Number
      }
    },
    attached: function() {
      this.register(this.url);
      this.startPolling();
    },
    detached: function() {
      this.unregister(this.url);
    },
    onMetrics: function(result) {

      var items = result.map(function(r) {
        return new Entry(r.Name, r.Value);
      });

      this._setItems(items);
      this._calculateThreshold(items);

    },
    _calculateThreshold: function(items) {

      if (!this.thresholdDanger && !this.thresholdWarning) {
        return;
      }

      var thresholdClass = 'threshold-success';

      for (var i = 0; i < items.length; i++) {

        var item = items[i];

        if (this.thresholdDanger && item.value >= this.thresholdDanger) {
          thresholdClass = 'threshold-danger';
          break;
        }
        else if (this.thresholdWarning && item.value >= this.thresholdWarning) {
          thresholdClass = 'threshold-warning';
          break;
        }

      }

      this._setThreshold(thresholdClass);

    }
  });

})();
</script>

</dom-module>
