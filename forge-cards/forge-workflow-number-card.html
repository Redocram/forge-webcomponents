<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/polymer/polymer.html">

<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-styles/color.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-styles/typography.html">

<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-card/paper-card.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-item/paper-icon-item.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-icon-button/paper-icon-button.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-item/paper-item-body.html">

<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/iron-collapse/iron-collapse.html">

<link rel="import" href="../forge-behaviors/forge-polling-behavior.html">
<link rel="import" href="../forge-behaviors/forge-localize-behavior.html">

<link rel="import" href="../forge-shared/forge-shared.html">
<link rel="import" href="../forge-shared/forge-icons.html">

<dom-module id="forge-workflow-number-card">

<style>
:root {

  --paper-item-focused-before: {
    background-color: transparent;
  }

}

:host {
  display: block;
}

paper-card {
  display: block;
}

.group-title {
  @apply(--paper-font-title);
}

.paper-item-group {
  background: var(--google-grey-100);
}

.paper-item-detail {
  cursor: pointer;
  cursor: hand;
}

.stageTotal {
  font-size: 16px;
  text-transform: capitalize;
}

.capitalize {
  text-transform: capitalize;
}

.entity-icon-wrapper {
  display: inline-block;
  box-sizing: border-box;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--google-grey-300);
}

.entity-icon {
  margin: 8px;
  width: 24px;
  height: 24px;
  --iron-icon-fill-color: white;
}
</style>

<template>

  <paper-card heading="[[localize('wcm.workflowNumbersHeader')]]">

    <div class="card-content">

      <template is="dom-repeat" items="{{stages}}" as="stage">
        <paper-icon-item class="paper-item-group">
          <paper-item-body class="group-title stageTotal">[[localize(stage.WorkflowStatus)]]: [[stage.Total]]</paper-item-body>
          <paper-icon-button icon="expand-more" alt="expand" on-tap="_toggle"></paper-icon-button>
        </paper-icon-item>
        <iron-collapse id$="collapse-[[stage.WorkflowStatus]]">
          <template is="dom-repeat" items="{{stage.ByEntity}}">
            <paper-icon-item class="paper-item-detail" on-tap="_openItem">
              <div class="entity-icon-wrapper" style$="background:[[item.IconItem.color]]" item-icon>
                <iron-icon class="entity-icon" icon="[[item.IconItem.icon]]"></iron-icon>
              </div>
              <paper-item-body class="capitalize">[[localize(item.PluralType)]]: [[item.Count]]</paper-item-body>
            </paper-icon-item>
          </template>
        </iron-collapse>
      </template>

    </div>

  </paper-card>

</template>
<script>
(function() {
  "use strict";

  Polymer({
    is: 'forge-workflow-number-card',
    behaviors: [ForgeWebComponents.Behaviors.PollingBehavior, ForgeWebComponents.Behaviors.ForgeLocalizeBehavior],
    properties: {
      url: {
        type: String,
        value: "/api/extensions/query/dashboards-wcm-stages-totals"
      },
      interval: {
        type: Number,
        value: 600000
      }
    },

    stages:[],

    _onPollingUpdate: function(result) {

      result.forEach(function(r) {

        r.ByEntity.forEach(function(e) {
          e.IconItem = ForgeWebComponents.Settings.EntityIcons[e.EntityType];
          e.PluralType = ForgeWebComponents.Helpers.EntityHelper.pluralize(e.EntityType);

          //Needed to build ForgeUrl
          e.WorkflowStatus = r.WorkflowStatus;
        });

      });

      this.stages = result.sort(function(a,b){
        return a.WorkflowStatus.localeCompare(b.WorkflowStatus);
      });

    },

    _toggle: function(e) {
      var collapse = this.$$("#collapse-" + e.model.stage.WorkflowStatus);
      var opened = !collapse.opened;
      collapse.toggle();
      if (opened) {
        e.target.setAttribute('icon', 'expand-less');
        e.target.setAttribute('alt', 'collapse');
      }
      else {
        e.target.setAttribute('icon', 'expand-more')
        e.target.setAttribute('alt', 'expand');
      }
    },
    _openItem: function(e) {
      var item = e.model.item;
      var query = this._workflowStatusQueryString(item.WorkflowStatus);

      var href = ForgeWebComponents.Helpers.EntityHelper.createSearchLink(item.EntityType, null, query);
      if (href) location.href = href;
    },
    _workflowStatusQueryString(workflowStatus){
      var result = {};
      var forgeStages =["published", "unpublished", "reviewed"];
      var forgeStatuses = ["archived"];

      if(forgeStages.indexOf(workflowStatus) > -1) {
        result.stage = workflowStatus;
      } else if(forgeStatuses.indexOf(workflowStatus) > -1){
        result.status = workflowStatus;
      }else if(workflowStatus){
        result["WorkflowFields.approvalStatus"] = workflowStatus;
      }

      return result;
    }
  });

})();
</script>

</dom-module>
