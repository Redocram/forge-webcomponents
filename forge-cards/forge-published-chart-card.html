<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/polymer/polymer.html">

<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-styles/color.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-styles/typography.html">

<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/paper-card/paper-card.html">
<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/google-chart/google-chart.html">

<link rel="import" href="//cdn.rawgit.com/download/polymer-cdn/1.6.1/lib/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../forge-behaviors/forge-localize-behavior.html">

<link rel="import" href="../forge-shared/forge-shared.html">

<dom-module id="forge-published-chart-card">

<style>
:host {
  display: block;
}

paper-card {
  display: block;
}

google-chart {
  height: 400px;
  width: 100%;
}
</style>

<template>

  <paper-card heading="[[localize('wcm.chartHeadingEntitiesByType')]]">
    <div>
      <google-chart id="publishedChart"
                    type="pie"
                    options="[[options]]"
                    data="[[data]]"></google-chart>
    </div>
  </paper-card>

</template>
<script>
(function() {
  "use strict";

  Polymer({
    is: 'forge-published-chart-card',
    behaviors: [Polymer.IronResizableBehavior, ForgeWebComponents.Behaviors.WcmPublishedPollingBehavior, ForgeWebComponents.Behaviors.ForgeLocalizeBehavior],
    properties: {
      url: {
        type: String
      }
    },
    listeners: {
      'iron-resize': '_onIronResize',
      'forge-language-changed': '_onLanguageChange'
    },
    data: null,
    options: null,
    attached: function() {
      this.polling.register(this.url, this);
      this.polling.start();
    },
    detached: function() {
      this.polling.unregister(this.url, this);
    },
    onPollingUpdate: function(result) {
      this._result = result;
      this._parseResult();
    },
    _parseResult: function() {

      if (!this._result) return;

      var working = _.cloneDeep(this._result);
      var header = working.splice(0, 1)[0];
      var colors = [];

      working.sort(function(a, b) {
        return a[1] < b[1];
      });

      for (var i = 0; i < working.length; i++) {

        var entityType = working[i][0];
        var color = ForgeWebComponents.Settings.EntityIcons[entityType]
          ?  ForgeWebComponents.Settings.EntityIcons[entityType].color
          : '#e0e0e0';

        //translate
        working[i][0] = this.localize(entityType);

        colors.push(color);

      }

      working.unshift(header);
      this.data = working;
      this.options = { colors: colors };

    },
    _onIronResize: function() {
      this.$.publishedChart.redraw();
    },
    _onLanguageChange: function() {
      this._parseResult();
    }
  });

})();
</script>

</dom-module>
